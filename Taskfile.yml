# yaml-language-server: $schema=https://taskfile.dev/schema.json
# https://taskfile.dev
version: "3"

vars:
  # Frequently changed
  SERVICES: mysql nginx

  # Rarely changed

tasks:
  ####################
  #      Deploy      #
  ####################
  deploy:
    desc: Deploy the latest configuration
    deps:
      - checkout
    cmds:
      - task: distribute-config
      - task: restart-all
      - task: reload-sysctl

  ####################
  #     Utility      #
  ####################
  checkout:
    desc: Checkout and sync with the latest remote branch
    vars:
      BRANCH: "{{.CLI_ARGS | default main}}"
    cmds:
      - git fetch --all
      - git reset --hard origin/{{.BRANCH}}
      - git switch -C {{.BRANCH}} origin/{{.BRANCH}}

  enable:
    desc: Enable and start specified services
    cmds:
      - |
        for service in "{{.CLI_ARGS}}"; do
          sudo systemctl enable --now $service && echo "$service enabled and started"
        done

  disable:
    desc: Disable and stop specified services
    cmds:
      - |
        for service in "{{.CLI_ARGS}}"; do 
          sudo systemctl disable --now $service && echo "$service disabled and stopped"
        done

  restart:
    desc: Restart specified services
    silent: true
    cmds:
      - |
        for service in "{{.CLI_ARGS}}"; do 
          sudo systemctl restart $service && echo "$service restarted"
        done

  restart-all:
    desc: Restart all services related to the application
    cmds:
      - |
        for service in "{{.SERVICES}}"; do 
          sudo systemctl restart $service && echo "$service restarted"
        done

  reload-sysctl:
    desc: Reload sysctl configuration
    cmds:
      - sudo sysctl -p

  ####################
  #     Internal     #
  ####################
  distribute-config:
    internal: true
    cmds:
      - |
        find "{{.USER_WORKING_DIR}}/common" -type f | while read -r src_path; do
          dst_path="/$(realpath --relative-to={{.USER_WORKING_DIR}}/common $src_path)"
          sudo cp -a "$src_path" "$dst_path"
        done
